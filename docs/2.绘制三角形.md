# ç»˜åˆ¶ä¸‰è§’å½¢

ç»è¿‡ä¸Šä¸€ç¯‡ï¼Œæˆ‘ä»¬ç®€å•çš„äº†è§£äº†æ•´ä¸ª webgpu ç¨‹åºçš„å¤§è‡´è¿è¡Œç»“æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹çœ‹å¦‚ä½•è¿›è¡Œç»˜åˆ¶æ“ä½œã€‚

## æ•°æ®å‡†å¤‡

ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä¸ª position çš„ attribute æ•°æ®ï¼Œä¸€ä¸ª color çš„ attribute æ•°æ®ï¼Œä»¥åŠ index ç´¢å¼•æ•°æ®ã€‚

```

// Position Vertex Buffer Data
const positions = new Float32Array([
    1.0     ,-1.0   ,0.0,   //ç¬¬ä¸€ä¸ªç‚¹ï¼ˆå³ä¸‹ï¼‰
    -1.0    ,-1.0   ,0.0,   //ç¬¬äºŒä¸ªç‚¹ï¼ˆå·¦ä¸‹ï¼‰
    0.0     ,1.0    ,0.0,   //ç¬¬ä¸‰ä¸ªç‚¹ï¼ˆä¸­ä¸Šï¼‰
]);

// Color Vertex Buffer Data
const colors = new Float32Array([
    1.0,0.0,0.0, // ğŸ”´
    0.0,1.0,0.0, // ğŸŸ¢
    0.0,0.0,1.0, // ğŸ”µ
]);

// Index Buffer Data
const indices = new Uint16Array([0, 2, 1]);

```

![](http://blogstatic.linhongxu.com/webgpu/triangle.png)

## Shader å‡†å¤‡

é¦–å…ˆ npm å®‰è£…`@webgpu/glslang`åº“ï¼Œç”¨æ¥å¸®åŠ©æˆ‘ä»¬ç¼–è¯‘ shander ç»™ webgpu è¿è¡Œã€‚ç„¶ååœ¨åˆå§‹åŒ–çš„ä»£ç ä¸­åŠ å…¥å¼•ç”¨ï¼Œå¹¶è°ƒç”¨é»˜è®¤å‡½æ•°åˆå§‹åŒ– glslangã€‚

```
import glslangModule from "@webgpu/glslang/dist/web-devel/glslang.onefile";

const glslang = await glslangModule();
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­å‡†å¤‡ shaderï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ glsl4.5 çš„ä»£ç æ ¼å¼è¿›è¡Œç¼–å†™ã€‚

**vertex shader**

```
#version 450

layout(location = 0) in vec3 aPosition;
layout(location = 1) in vec4 aColor;

layout(location = 0) out vec4 vColor;
void main() {
    gl_Position = vec4(aPosition, 1.0);
    vColor = aColor;
}
```

**fragment shader**

```
#version 450
layout(location = 0) in vec4 vColor;
layout(location = 0) out vec4 outColor;
void main(void) {
  outColor = vColor;
}
```

## åˆ›å»º Renderpipeline

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ device çš„`createRenderPipeline`æ–¹æ³•åˆ›å»ºç”¨äºæ¸²æŸ“çš„ `renderpipeline`ã€‚

```
const pipelineDesc: GPURenderPipelineDescriptor = {
        layout,
        vertexStage,
        fragmentStage,
        primitiveTopology: "triangle-list",
        colorStates: [colorState],
        vertexState,
        rasterizationState,
    };
const pipeline = device.createRenderPipeline(pipelineDesc);
```

æˆ‘ä»¬å…·ä½“æ¥çœ‹çœ‹ä»–ä»¬éƒ½æ˜¯å¹²å˜›ç”¨çš„ã€‚

**layout** æŒ‡çš„æ˜¯æ¸²æŸ“ç®¡çº¿çš„ç»“æ„ç¼–æ’ï¼Œä¸»è¦æ˜¯ç”¨æ¥åš uniform ç»‘å®šçš„,æœ¬æ¬¡ç¤ºä¾‹æ²¡æœ‰ä½¿ç”¨ uniformï¼Œæš‚æ—¶ç•™ç©ºï¼Œæ¥ä¸‹æ¥ä¼šæœ‰æ–‡ç« è¯¦ç»†è¯´ uniform çš„ä½¿ç”¨ã€‚

```
  const layout = device.createPipelineLayout({
        bindGroupLayouts: [],
    });
```

**vertexStage** å’Œ **fragmentStage** æ˜¯ä¸€ç»„å…³äºé¡¶ç‚¹å’Œç‰‡å…ƒç€è‰²å™¨çš„è®¾ç½®ã€‚æˆ‘ä»¬ä½¿ç”¨ device çš„`createShaderModule`æ–¹æ³•åˆ›å»º shader æ¨¡å—ï¼Œå¹¶æŒ‡å®šå…¥å£å‡½æ•°ã€‚

```
const vertexStage = {
    module: device.createShaderModule({
        code: glslang.compileGLSL(vs, "vertex", true),
    }),
    entryPoint: "main",
};

const fragmentStage = {
    module: device.createShaderModule({
        code: glslang.compileGLSL(fs, "fragment", true),
    }),
    entryPoint: "main",
};
```

**primitiveTopology** ä¸»è¦ç”¨æ¥è®¾ç½®å›¾å…ƒçš„ç»˜åˆ¶ä¿¡æ¯ï¼Œä¸€èˆ¬å›¾å…ƒçš„ç±»å‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§

```
export type GPUPrimitiveTopology =
    | "point-list"
    | "line-list"
    | "line-strip"
    | "triangle-list"
    | "triangle-strip"
```

**colorStates**æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºç»˜åˆ¶çš„é¢œè‰²ä¿¡æ¯è®¾ç½®,åŒ…æ‹¬é¢œè‰²æ ¼å¼èåˆè§„åˆ™ç­‰ã€‚

```
   const colorState: GPUColorStateDescriptor = {
        format: "bgra8unorm",
        alphaBlend: {
            srcFactor: "src-alpha",
            dstFactor: "one-minus-src-alpha",
            operation: "add",
        },
        colorBlend: {
            srcFactor: "src-alpha",
            dstFactor: "one-minus-src-alpha",
            operation: "add",
        },
        writeMask: GPUColorWrite.ALL,
    };
```

**vertexState** æ˜¯å…³äºç‰‡å…ƒç€è‰²å™¨çš„è®¾ç½®ä¿¡æ¯,åŒ…æ‹¬ index çš„æ ¼å¼ï¼Œvertexbuffer ç­‰ã€‚

```
const vertexState: GPUVertexStateDescriptor = {
    indexFormat: "uint16",
    vertexBuffers: [positionBufferDesc, colorBufferDesc],
};
```

**rasterizationState** æ˜¯å…³äºå…‰æ …åŒ–çš„è®¾ç½®ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‚æ•°

```
frontFace?: GPUFrontFace;   // æ­£é¢ä¸‰è§’å½¢ç»˜åˆ¶é¡ºåº é¡ºæ—¶é’ˆcw é€†æ—¶é’ˆccw
cullMode?: GPUCullMode;     // ä¸‰è§’é¢å‰”é™¤è§„åˆ™ "none" | "front" | "back"
depthBias?: number;         // æ·±åº¦è´´å›¾çš„biasæ•°å€¼
depthBiasSlopeScale?: number; //æ·±åº¦è´´å›¾biasçš„SlopeScaleå€¼
depthBiasClamp?: number;    //æ·±åº¦è´´å›¾biasçš„Clampå€¼
```

æ¸²æŸ“ç®¡çº¿çš„åˆ›å»ºå‚æ•°æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªåˆ—å‡ºäº†éƒ¨åˆ†å‚æ•°è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å‚æ•°å¯ä»¥è®¾ç½®ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ã€‚å¤§è‡´åŒ…å«ä¸‹é¢è¿™äº›å‚æ•°ï¼Œå¯ä»¥å®šä¹‰æ¸²æŸ“ç®¡çº¿ä¸­çš„å„ä¸ªé˜¶æ®µå±æ€§ã€‚

```
layout: GPUPipelineLayout;
vertexStage: GPUProgrammableStageDescriptor;
fragmentStage?: GPUProgrammableStageDescriptor;

primitiveTopology: GPUPrimitiveTopology;
rasterizationState?: GPURasterizationStateDescriptor;
colorStates: GPUColorStateDescriptor[];
depthStencilState?: GPUDepthStencilStateDescriptor;
vertexState?: GPUVertexStateDescriptor;

sampleCount?: number;
sampleMask?: number;
alphaToCoverageEnabled?: boolean;
```

## å†™å…¥ buffer æ•°æ®

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªé€šç”¨çš„å¸®åŠ©å‡½æ•°æ¥ä½¿ç”¨ device çš„ `createBufferMapped` api åˆ›å»º GPUBuffer å¯¹è±¡ï¼Œå¹¶å°† typedarray çš„ buffer æ•°æ®ä¼ å…¥è¿›å»ã€‚

```
  createBuffer(
        fromTypedArray: Float32Array | Uint16Array | Uint32Array,
        usage: GPUBufferUsage
    ) {
        let desc = { size: fromTypedArray.byteLength, usage };
        let [buffer, bufferMapped] = device.createBufferMapped(desc);

        // @ts-ignore
        new fromTypedArray.constructor(bufferMapped).set(fromTypedArray);
        buffer.unmap();
        return buffer;
    }
```

## ä½¿ç”¨ renderpipeline

åˆ›å»ºå¥½ pipeline åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ renderpass ä¸­è®¾ç½® renderpipelineã€‚ç„¶åè®¾ç½® vertexbuffer å’Œ indexbufferï¼Œæœ€åæ‰§è¡Œ drawindexed çš„å‡½æ•°è¿›è¡Œç»˜åˆ¶ã€‚

```
renderPassEncoder.setPipeline(pipeline);
renderPassEncoder.setVertexBuffer(0, positionBuffer);
renderPassEncoder.setVertexBuffer(1, colorBuffer);
renderPassEncoder.setIndexBuffer(indexBuffer);
renderPassEncoder.drawIndexed(3, 1, 0, 0, 0);
```

å…¶ä»–æµç¨‹å’Œä¹‹å‰æ¸…å± demo ä¸­çš„ä¿æŒä¸€è‡´ã€‚æ€»çš„æµç¨‹å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://blogstatic.linhongxu.com/webgpu/workflow.png)

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å±å¹•ä¸­æ­£ç¡®çš„ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢äº†ã€‚ä¸è¿‡è¿™ä¸ªä¸‰è§’å½¢çœ‹ä¸Šå»è¿˜æ˜¯è¿‡äºâ€œå¹³é¢â€ï¼Œå¹¶ä¸æ˜¯ååˆ†ç«‹ä½“ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»§ç»­æ¢ç´¢ç”Ÿæˆæ›´åŠ ç«‹ä½“çš„å›¾å½¢ã€‚
